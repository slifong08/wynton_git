### 
# Identification of species-specific ATAC-seq peaks in livers, small intestine, and muscle samples from fruit and insect bats using hg38 to compare between genomes. 
# 20230803
# SarahFong
###


###
# Materials
###

# scaffold and chain annotations
ArtJam2: GCF_014825515.1_WHU_Ajam_v2_assembly_report.txt
EptFus1: replace_efus-ucsc_with_efus-ncbi.txt  # generated by Wei


# chain files
Human to ArtJam2 chain file: hg38.chr1_22.ArtJamW.chain.final.gz
ArtJam2 to human chain file: ArtJamW.chr1_22.hg38.chain.final.gz
Human to EptFus1 chain file: hg38ToEptFus1.over.chain.gz  # from UCSC genome browser
EptFus1 to human chain file:   # from UCSC genome browser

# software
LiftOver  # software from UCSC for traversing genomes
BedTools  # software from Aaron Quinlan for intersecting genomic regions. 

# scripts
directory: /wynton/home/ahituv/fongsl/other_analyses/for-hai_bats/bin/

./1.raw.data.ipynb
./2.liftover.ipynb
./3.intersect_peaks_in_hg38.ipynb

###
# Methods
###

LiftOver: Ashley called peaks for this project. Liver, small intestine, and pectoral muscles ATAC-seq peaks from frugivorous Artibeus Jamaicensis ('Ajam') and insectivore Eptesicus Fuscus ('Efus') were lifted over to Hg38 using LiftOver from UCSC with a minimum match of 10% sequence identity. To more narrowly identify reciprocal matches between genomes and reduce the number of one-to-many liftover peaks, I reciprocally lifted over the hg38 liftover peaks back to the original genome build. 

Species-specific peaks: To get species-specific peaks per tissue, Ajam and Efus peaks in Hg38 coordinates were intersected using BedTools and the arguments "-v" to subtract one peak set from another,  "-f 0.1" to exclude any peak where 10% of the length overlaps the other species, and "-r" to remove reciprocal peaks. 

### 
# Results
###

# Reciprocal Liftover:

- In Ajam (ArtJam2), 7664 of 12994 liver peak (59.0%), 8 of 374 pectoral muscle peaks (2.1%), and 21936 of 37265 (58.9%) of small intestine peaks reciprocally lifted over to Hg38. 

- In Efus (EptFus1), 61389 of 79401 liver peaks (77.3%), 31698 of 32167 pectoral muscle peaks (98.5%) and 35815 of 51934 small intestine peaks (69.0%) were lifted over to Hg38. 

# Species-specific peaks:

- In Ajam, 2218 liver (28.9%), 8 pectoral muscle (100%), and 9765 (44.5%) small intestine peaks were specific. 

- In Efus, 55902 liver (91.1%), 31697 pectoral muscle (98.5%), and 23195  small intestine peaks (64.8%) were specific. 


###
# Next questions
###

- is <10% reciprocal overlap okay? Should we require less than 10% reciprocal overlap to be extra strict about species-specific peaks? E.g. call any peak with 0 bp overlap as "species-specific"?

- do we want to test both fruit and insect sequences in MPRA when one peak is species-specific? 


### 
# Designing fruit bat-specific MPRA from ArtJam-specific ATAC-seq peaks in liver samples. Originally identified from fruit and insect bat ATAC-seq data using hg38 to compare between genomes. 
# 20231117
# SarahFong
###

Here, I will take the 2218 ArtJam differentially accessible liver peaks and design an MPRA for Hai. This MPRA will be tested in HepG2 cells. Per Hai's request, I will design these sequences using the fruit bat genome build, ArtJam2. 

###
# Materials
###

# liver ATAC peaks
ArtJam2-specific liver peaks (in hg38 coordinates): /wynton/home/ahituv/fongsl/other_analyses/for-hai_bats/data/CallPeaks_results_for_Sarah/Artibeus_jamaicensis/liver.ajam.specific.bed

# chain files
ArtJam2 to human chain file: ArtJamW.chr1_22.hg38.chain.final.gz

# genome fasta file
ArtJam2 fasta file: /wynton/group/ahituv/data/dna/ArtJam2/ArtJam2_scaffolds_largerthan_50kb.fa

# scripts
directory: /wynton/home/ahituv/fongsl/other_analyses/for-hai_bats/bin/

./4.liftOver.artJam.liverspecific.to.artjam.ipynb
./5.artjam.specific.liver.MPRA.ipynb

###
# Methods
###

    - First, I took the liver Ajam-specific elements (N=2218) in hg38 and lifted these elements back into ArtJam2 coordinates using LiftOver from UCSC. 

    - Second, I extracted the fasta sequences from ArtJam2 bed coordinates using BedTool's getfasta function and the ArtJam2 fasta scaffolds that are larger than 50kb. These larger scaffolds reflect more completely assembled regions than smaller ones, and were originally generated from Wei Gordon, Zhe Liu, or another collaborator. 

    - Third, for each fasta sequence, I tiled across ArtJam-specific accessible liver loci, generating 200bp long tiles with a 20bp shift. While sliding across the sequence, when the window exceeds the end of the sequence (thus, overlapping <200bp of the locus), I exclude these tiles. This means the last 1-19 nucleotides on any locus might not be included in the MPRA design. This results in N=52,698 tiles. During this tiling process, I compute the GC fraction for each element.

        - Thresholding on GC content >=40% and <=60%, N = 22,567 meet this criteria (43%, or 22,567/52,698 tiles). I also made a separate shuffled set for these GC content controlled elements. 

    - Fourth, I randomly select 300 tiles from the full pool of tiles and perform dinucleotide shuffling of those sequences. I also randomly selected 300 tiles from the pool of tiles with GC content >=40% and <= 60%.  

    - Fifth, I added in N = 169 HepG2 synthetic negative controls and N = 181 HepG2 synthetic positive controls. These sequences are 200bp long and were taken from the Agarwal 2023 paper. They were originally built in Hg38. Noteâ€”filtering the positive and negative controls, 315/350 elements meet the GC content filtering criteria. Of these, 172/181 positive controls and 143/169 negative controls meet the GC content criteria. 

    - Sixth, I attach illumina adaptors to the 5' and 3' ends of these sequences. The 5' adaptor sequences is AGGACCGGATCAACT and the 3' adaptor sequence is CATTGCGTGAACCGA. At this step, I also computed the reverse complement, in case needed. 

###
# Summary
###

In total, this resulted in:

    Ajam-specific Liver ATAC-loci N = 2218 
    
    # full dataset
    Full dataset = 53298 tiles in forward direction, 53298 in reverse direction
    
    Ajam-specific Liver ATAC-loci tiles N = 52698
    Shuffled dinucleotide elements from randomly sampled tiles N = 300
    Synthetic HepG2 positive control tiles N = 181
    Synthetic HepG2 negative control tiles N = 169
    
    # Filter GC content >=40% and <=60% dataset
    Full dataset = 23182 tiles in forward direction, 23182 in reverse direction
    
    Ajam-specific Liver ATAC-loci tiles N = 22567 
    Shuffled dinucleotide elements from randomly sampled tiles N = 300
    Synthetic HepG2 positive control tiles N = 172 
    Synthetic HepG2 negative control tiles N = 143 
    
    # GC content note
    NOTE: The GC content for the positive and negative controls is much lower than the gc content for the tiles, shuffles. This is true even when filtering on GC content >=40% and <= 60%. 
        Median ctrl GC content = 49%
        Median Ajam liver tile, filtered for GC content = 54%
        Median Ajam liver tile = 61%

###
# questions for HAI
###
# GC fraction thresholding? 
# forward v. reverse